# Flow Design - Telegram & Mobile Platform

## Database Schema Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   user_profiles     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID, PK)      â”‚
â”‚ user_id (TEXT)     â”‚ â† User identifier (unique)
â”‚ first_name (TEXT) â”‚
â”‚ last_name (TEXT)  â”‚
â”‚ avatar_url (TEXT) â”‚ â† URL cá»§a avatar image (optional)
â”‚ created_at         â”‚
â”‚ updated_at         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ (1:1)
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   transcriptions    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ transcription_id (UUID, PK)â”‚
â”‚ content (TEXT)      â”‚ â† Full transcription text
â”‚ created_at         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ (1:N)
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   conversations     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID, PK)      â”‚ â† Telegram/Mobile táº¡o UUID
â”‚ user_id (TEXT)     â”‚ â† Link to user_profiles.user_id
â”‚ transcription_id (FK)â”‚
â”‚ title              â”‚ â† Title cá»§a conversation
â”‚ platform           â”‚ â† 'telegram' or 'mobile'
â”‚ metadata           â”‚ â† JSON field (extra data)
â”‚ source_type        â”‚ â† 'audio', 'video', 'voice_message', etc.
â”‚ is_active (BOOL)  â”‚
â”‚ created_at         â”‚
â”‚ updated_at         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ (1:N)
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      messages       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (UUID, PK)      â”‚
â”‚ conversation_id (FK)â”‚
â”‚ role (user/assistant)â”‚
â”‚ content (TEXT)      â”‚
â”‚ file_url (VARCHAR) â”‚ â† URL cá»§a file Ä‘Ã­nh kÃ¨m (optional)
â”‚ file_name (VARCHAR) â”‚ â† TÃªn file (optional)
â”‚ file_type (VARCHAR) â”‚ â† Loáº¡i file: 'image', 'video', 'audio', 'document' (optional)
â”‚ file_size (BIGINT) â”‚ â† KÃ­ch thÆ°á»›c file (bytes) (optional)
â”‚ created_at         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flow 1: Telegram Bot - User gá»­i Audio/Video

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER gá»­i Audio/Video trÃªn Telegram                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MessageHandler.handle(event)                                â”‚
â”‚ - Detect media type (audio/video/voice)                     â”‚
â”‚ - Extract user_id tá»« sender                                 â”‚
â”‚ - Detect source_type: 'audio', 'video_file', 'voice_message'â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MediaService.transcribe_audio(audio_path)                   â”‚
â”‚                                                             â”‚
â”‚ IF file_size > 10MB:                                        â”‚
â”‚   â”œâ”€> MediaService._transcribe_with_ffmpeg_chunking()      â”‚
â”‚   â”‚   â”œâ”€> Split file thÃ nh chunks                          â”‚
â”‚   â”‚   â”œâ”€> Transcribe chunks in parallel (max 5 concurrent) â”‚
â”‚   â”‚   â””â”€> Merge transcriptions                             â”‚
â”‚   â”‚                                                         â”‚
â”‚ ELSE:                                                       â”‚
â”‚   â””â”€> MediaService._transcribe_single_audio()               â”‚
â”‚                                                             â”‚
â”‚ â””â”€> OpenRouterAPI.transcribe_audio(audio_base64)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ [transcribed_text]
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AIService.generate_metadata(transcribed_text)                â”‚
â”‚ - Call OpenRouter API vá»›i structured output                â”‚
â”‚ - Return: {title, summary}                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ [metadata: title, summary]
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [TRANSCRIPTION STEP]                                         â”‚
â”‚                                                             â”‚
â”‚ TranscriptionRepository.create_transcription()               â”‚
â”‚ â”œâ”€> Generate transcription_id = UUID (auto)                â”‚
â”‚ â”œâ”€> INSERT INTO transcriptions:                              â”‚
â”‚ â”‚   - transcription_id = UUID                               â”‚
â”‚ â”‚   - content = transcribed_text  â† Full transcription text â”‚
â”‚ â”‚   - created_at = CURRENT_TIMESTAMP                        â”‚
â”‚ â””â”€> Return transcription_id                                  â”‚
â”‚                                                             â”‚
â”‚ Note: Title, summary, duration, source_type Ä‘Æ°á»£c lÆ°u vÃ o    â”‚
â”‚       conversations.metadata vÃ  conversations.title         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ [transcript_id, metadata, source_type]
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [CONVERSATION STEP]                                          â”‚
â”‚                                                             â”‚
â”‚ ConversationRepository.create_conversation()                 â”‚
â”‚ â”œâ”€> Telegram handler táº¡o conversation_id = UUID              â”‚
â”‚ â”‚   (cÃ³ thá»ƒ dÃ¹ng uuid4() hoáº·c custom UUID)                  â”‚
â”‚ â”œâ”€> Deactivate all other conversations cá»§a user              â”‚
â”‚ â”‚   UPDATE conversations SET is_active = FALSE              â”‚
â”‚ â”‚   WHERE user_id = ? AND is_active = TRUE                   â”‚
â”‚ â”œâ”€> INSERT INTO conversations:                             â”‚
â”‚ â”‚   - id = conversation_id (UUID tá»« Telegram handler)       â”‚
â”‚ â”‚   - user_id                                                â”‚
â”‚ â”‚   - transcription_id                                       â”‚
â”‚ â”‚   - title = metadata.title  â† Title cá»§a conversation      â”‚
â”‚ â”‚   - platform = 'telegram'  â† Platform identifier          â”‚
â”‚ â”‚   - metadata = JSON  â† Extra metadata (summary, etc.)     â”‚
â”‚ â”‚   - source_type = source_type  â† 'audio', 'video', etc.   â”‚
â”‚ â”‚   - is_active = TRUE                                       â”‚
â”‚ â”‚   - created_at = CURRENT_TIMESTAMP                         â”‚
â”‚ â”‚   - updated_at = CURRENT_TIMESTAMP                         â”‚
â”‚ â””â”€> Return conversation_id                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ [conversation_id, transcript_id]
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [RESPONSE]                                                   â”‚
â”‚                                                             â”‚
â”‚ event.reply()                                                â”‚
â”‚ "âœ… Transcribed!\n\n"                                        â”‚
â”‚ "ğŸ“ {title}\n"                                               â”‚
â”‚ '"{summary}"'                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flow 2: Mobile App - Upload Audio/Video

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mobile Handler táº¡o conversation_id = UUID                   â”‚
â”‚ (Mobile tá»± táº¡o UUID trÆ°á»›c khi gá»i API)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ [conversation_id, user_id, file/url]
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mobile App gá»i API                                          â”‚
â”‚ POST /transcribe/audio-mobile                                â”‚
â”‚ POST /transcribe/video-url-mobile                           â”‚
â”‚                                                             â”‚
â”‚ Request body:                                                â”‚
â”‚ {                                                            â”‚
â”‚   user_id: string,                                          â”‚
â”‚   conversation_id: uuid,  â† Mobile handler Ä‘Ã£ táº¡o           â”‚
â”‚   file: File hoáº·c video_url: string                         â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ [user_id, conversation_id, file/url]
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ api.py: transcribe_audio_mobile() /                         â”‚
â”‚         transcribe_video_url_mobile()                        â”‚
â”‚                                                             â”‚
â”‚ - Save uploaded file to media/audio/                        â”‚
â”‚ - Download video audio (if URL)                             â”‚
â”‚ - Detect source_type: 'audio', 'video', 'url'                â”‚
â”‚ - Nháº­n conversation_id tá»« request (Mobile Ä‘Ã£ táº¡o)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MediaService.transcribe_audio(audio_path)                   â”‚
â”‚ (Same as Flow 1)                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ [transcribed_text]
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AIService.generate_metadata(transcribed_text)                â”‚
â”‚ (Same as Flow 1)                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ [metadata]
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [TRANSCRIPTION STEP]                                         â”‚
â”‚                                                             â”‚
â”‚ TranscriptionRepository.create_transcription()                â”‚
â”‚ (Same as Flow 1)                                            â”‚
â”‚ â””â”€> Return transcription_id                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ [transcription_id]
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [SAVE TRANSCRIPT TO FILE & UPLOAD S3]                       â”‚
â”‚                                                             â”‚
â”‚ - Save transcript to media/transcripts/                     â”‚
â”‚ - Upload to S3: upload_file_to_s3()                         â”‚
â”‚ - Get S3 URL                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ [s3_transcript_url]
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [CONVERSATION STEP]                                          â”‚
â”‚                                                             â”‚
â”‚ ConversationRepository.create_conversation()                  â”‚
â”‚ â”œâ”€> Nháº­n conversation_id tá»« Mobile handler (Ä‘Ã£ cÃ³ sáºµn)     â”‚
â”‚ â”œâ”€> Deactivate all other conversations cá»§a user              â”‚
â”‚ â”œâ”€> Prepare metadata JSON:                                  â”‚
â”‚ â”‚   {                                                        â”‚
â”‚ â”‚     "summary": metadata.summary,                          â”‚
â”‚ â”‚     "duration_seconds": duration,                         â”‚
â”‚ â”‚     "transcript_file_path": s3_transcript_url             â”‚
â”‚ â”‚   }                                                        â”‚
â”‚ â”œâ”€> INSERT INTO conversations:                              â”‚
â”‚ â”‚   - id = conversation_id (UUID tá»« Mobile handler)         â”‚
â”‚ â”‚   - user_id                                               â”‚
â”‚ â”‚   - transcription_id                                      â”‚
â”‚ â”‚   - title = metadata.title  â† Title cá»§a conversation     â”‚
â”‚ â”‚   - platform = 'mobile'  â† Platform identifier           â”‚
â”‚ â”‚   - metadata = JSON  â† Extra metadata                     â”‚
â”‚ â”‚   - source_type = source_type  â† 'audio', 'video', etc.  â”‚
â”‚ â”‚   - is_active = TRUE                                      â”‚
â”‚ â”‚   - created_at = CURRENT_TIMESTAMP                        â”‚
â”‚ â”‚   - updated_at = CURRENT_TIMESTAMP                        â”‚
â”‚ â””â”€> Return conversation_id (same as input)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ [transcription_id]
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [RESPONSE]                                                   â”‚
â”‚                                                             â”‚
â”‚ Return TranscribeResponse (Minimal - chá»‰ IDs):             â”‚
â”‚ {                                                            â”‚
â”‚   success: true,                                            â”‚
â”‚   transcription_id: transcription_id,  â† Mobile query Ä‘á»ƒ láº¥y contentâ”‚
â”‚   message: "Transcription completed successfully"            â”‚
â”‚ }                                                            â”‚
â”‚                                                             â”‚
â”‚ Note: conversation_id khÃ´ng cáº§n tráº£ vá» vÃ¬ Mobile Ä‘Ã£ biáº¿t    â”‚
â”‚       (Mobile Ä‘Ã£ táº¡o vÃ  gá»­i lÃªn)                            â”‚
â”‚                                                             â”‚
â”‚ Mobile sáº½ tá»± query:                                         â”‚
â”‚ 1. GET /transcriptions/{transcription_id}                   â”‚
â”‚    â†’ Láº¥y transcription content                              â”‚
â”‚                                                             â”‚
â”‚ 2. GET /conversations/{conversation_id}                     â”‚
â”‚    â†’ Láº¥y conversation details (title, metadata, etc.)      â”‚
â”‚    â†’ conversation_id Ä‘Ã£ cÃ³ sáºµn tá»« Mobile                    â”‚
â”‚                                                             â”‚
â”‚ LÃ½ do chá»‰ tráº£ vá» transcription_id:                         â”‚
â”‚ âœ… Conversation_id Mobile Ä‘Ã£ biáº¿t (Ä‘Ã£ táº¡o)                  â”‚
â”‚ âœ… Chá»‰ cáº§n transcription_id Ä‘á»ƒ query content               â”‚
â”‚ âœ… Response nhá» gá»n nháº¥t                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Response Structure cho Mobile API**

**Chá»‰ tráº£ vá» IDs (Recommended)**
```json
{
  "success": true,
  "transcription_id": "uuid-here",
  "conversation_id": "uuid-here",
  "message": "Transcription completed successfully"
}
```

**Æ¯u Ä‘iá»ƒm:**
- âœ… Response nhá» gá»n, nhanh
- âœ… Mobile cÃ³ control khi nÃ o query data
- âœ… Giáº£m bandwidth
- âœ… Conversation_id Ä‘á»§ Ä‘á»ƒ báº¯t Ä‘áº§u chat ngay
- âœ… Transcription_id Ä‘á»§ Ä‘á»ƒ query content khi cáº§n

**Mobile sáº½ query:**
1. `GET /transcriptions/{transcription_id}` â†’ Láº¥y transcription content
2. `GET /conversations/{conversation_id}` â†’ Láº¥y conversation details (title, metadata, etc.)



---

## Flow 3: Chat vá»›i Active Conversation (Telegram)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER gá»­i text message trÃªn Telegram                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MessageHandler._handle_text_message(event, user_id, text)   â”‚
â”‚                                                             â”‚
â”‚ - Check if text contains URL â†’ skip if yes                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ConversationRepository.get_active_conversation(user_id)      â”‚
â”‚                                                             â”‚
â”‚ SELECT c.*, t.content as transcription_content            â”‚
â”‚ FROM conversations c                                        â”‚
â”‚ JOIN transcriptions t ON c.transcription_id = t.transcription_idâ”‚
â”‚ WHERE c.user_id = ? AND c.is_active = TRUE                 â”‚
â”‚ ORDER BY c.updated_at DESC LIMIT 1                         â”‚
â”‚                                                             â”‚
â”‚ Return: {                                                    â”‚
â”‚   id, user_id, transcription_id,                            â”‚
â”‚   title, platform, metadata, source_type,                 â”‚
â”‚   is_active, created_at, updated_at,                        â”‚
â”‚   transcription_content (from transcriptions.content)        â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ [conversation: {id, transcription_id, title, ...}]
                     â”‚ [transcription_content]
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MessageRepository.get_conversation_history(                 â”‚
â”‚   conversation_id                                           â”‚
â”‚ )                                                           â”‚
â”‚                                                             â”‚
â”‚ SELECT role, content, file_url, file_name, file_type, file_sizeâ”‚
â”‚ FROM messages                                                â”‚
â”‚ WHERE conversation_id = ?                                   â”‚
â”‚ ORDER BY created_at ASC                                     â”‚
â”‚                                                             â”‚
â”‚ Return: [{role: 'user', content: '...', file_url: '...', ...}, ...]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ [history: List[Dict]]
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AIService.get_response(                                     â”‚
â”‚   user_message,                                             â”‚
â”‚   transcription_content,                                     â”‚
â”‚   history                                                    â”‚
â”‚ )                                                           â”‚
â”‚                                                             â”‚
â”‚ - Build messages vá»›i system prompt + transcription          â”‚
â”‚ - Add history messages                                      â”‚
â”‚ - Add user message                                          â”‚
â”‚ - Call OpenRouterAPI.chat_completion()                      â”‚
â”‚ - Return AI response                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ [ai_response]
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [SAVE MESSAGES]                                             â”‚
â”‚                                                             â”‚
â”‚ MessageRepository.add_message(                               â”‚
â”‚   conversation_id, 'user', user_message                     â”‚
â”‚ )                                                           â”‚
â”‚                                                             â”‚
â”‚ MessageRepository.add_message(                               â”‚
â”‚   conversation_id, 'assistant', ai_response                 â”‚
â”‚ )                                                           â”‚
â”‚                                                             â”‚
â”‚ INSERT INTO messages                                         â”‚
â”‚ (conversation_id, role, content, file_url, file_name, file_type, file_size)â”‚
â”‚ VALUES (?, 'user', ?, ?, ?, ?, ?), (?, 'assistant', ?, NULL, NULL, NULL, NULL)â”‚
â”‚                                                             â”‚
â”‚ Note: file_url, file_name, file_type, file_size chá»‰ dÃ¹ng khiâ”‚
â”‚       message cÃ³ file Ä‘Ã­nh kÃ¨m (optional, NULL náº¿u khÃ´ng cÃ³)â”‚
â”‚                                                             â”‚
â”‚ [UPDATE CONVERSATION]                                       â”‚
â”‚ UPDATE conversations                                        â”‚
â”‚ SET updated_at = CURRENT_TIMESTAMP                          â”‚
â”‚ WHERE id = conversation_id                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [RESPONSE]                                                   â”‚
â”‚                                                             â”‚
â”‚ send_long_message(event, ai_response)                       â”‚
â”‚ - Split long messages náº¿u > MAX_MESSAGE_LENGTH             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flow 4: Chat vá»›i Active Conversation (Mobile)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mobile App POST /chat                                       â”‚
â”‚ {                                                            â”‚
â”‚   user_id: int,                                            â”‚
â”‚   message: str,                                             â”‚
â”‚   context_id: Optional[str]  â† Optional conversation_id     â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ api.py: chat(request: ChatRequest)                          â”‚
â”‚                                                             â”‚
â”‚ IF request.context_id:                                      â”‚
â”‚   â””â”€> Get conversation by context_id                      â”‚
â”‚ ELSE:                                                       â”‚
â”‚   â””â”€> Get active conversation                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ConversationRepository.get_active_conversation(user_id)      â”‚
â”‚ OR                                                          â”‚
â”‚ ConversationRepository.get_conversation_by_id(context_id)   â”‚
â”‚                                                             â”‚
â”‚ SELECT c.*, t.content as transcription_content            â”‚
â”‚ FROM conversations c                                        â”‚
â”‚ JOIN transcriptions t ON c.transcription_id = t.transcription_idâ”‚
â”‚ WHERE c.id = ? OR (c.user_id = ? AND c.is_active = TRUE)   â”‚
â”‚                                                             â”‚
â”‚ Return: {                                                    â”‚
â”‚   id, user_id, transcription_id,                            â”‚
â”‚   title, platform, metadata, source_type,                  â”‚
â”‚   is_active, created_at, updated_at,                       â”‚
â”‚   transcription_content (from transcriptions.content)        â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ [conversation: {id, transcription_id, title, ...}]
                     â”‚ [transcription_content]
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MessageRepository.get_conversation_history(                  â”‚
â”‚   conversation_id                                           â”‚
â”‚ )                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ [history]
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AIService.get_response(user_message, transcription, history)â”‚
â”‚ (Same as Flow 3)                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ [ai_response]
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [SAVE MESSAGES]                                             â”‚
â”‚ (Same as Flow 3)                                            â”‚
â”‚                                                             â”‚
â”‚ [UPDATE CONVERSATION]                                       â”‚
â”‚ UPDATE conversations                                        â”‚
â”‚ SET updated_at = CURRENT_TIMESTAMP                          â”‚
â”‚ WHERE id = conversation_id                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [RESPONSE]                                                   â”‚
â”‚                                                             â”‚
â”‚ Return ChatResponse:                                        â”‚
â”‚ {                                                            â”‚
â”‚   success: true,                                            â”‚
â”‚   response: ai_response                                     â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flow 5: Switch Conversation (Telegram only)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER gá»­i /switch <num>                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CommandHandler.handle_switch(event, args)                    â”‚
â”‚                                                             â”‚
â”‚ - Parse index tá»« args                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ConversationRepository.get_user_conversations(user_id)      â”‚
â”‚                                                             â”‚
â”‚ SELECT c.*,                                                 â”‚
â”‚        c.metadata->>'summary' as summary,                  â”‚
â”‚        c.metadata->>'duration_seconds' as duration_seconds â”‚
â”‚ FROM conversations c                                        â”‚
â”‚ WHERE c.user_id = ?                                         â”‚
â”‚ ORDER BY c.created_at DESC                                  â”‚
â”‚                                                             â”‚
â”‚ Return: List[{                                               â”‚
â”‚   id, user_id, transcription_id,                            â”‚
â”‚   title, platform, metadata, source_type,                  â”‚
â”‚   is_active, created_at, updated_at,                       â”‚
â”‚   summary, duration_seconds (from metadata JSON)            â”‚
â”‚ }]                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ [conversations: List[Conversation]]
                     â”‚
                     â”‚ Get conversation by index (1-based)
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ConversationRepository.set_active_conversation(              â”‚
â”‚   user_id,                                                  â”‚
â”‚   conversation_id                                           â”‚
â”‚ )                                                           â”‚
â”‚                                                             â”‚
â”‚ BEGIN TRANSACTION:                                          â”‚
â”‚   1. UPDATE conversations                                   â”‚
â”‚      SET is_active = FALSE, updated_at = CURRENT_TIMESTAMP â”‚
â”‚      WHERE user_id = ? AND is_active = TRUE                 â”‚
â”‚                                                             â”‚
â”‚   2. UPDATE conversations                                   â”‚
â”‚      SET is_active = TRUE, updated_at = CURRENT_TIMESTAMP â”‚
â”‚      WHERE id = ? AND user_id = ?                          â”‚
â”‚                                                             â”‚
â”‚ COMMIT                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [RESPONSE]                                                   â”‚
â”‚                                                             â”‚
â”‚ event.reply()                                                â”‚
â”‚ "âœ… â†’ {conversation.title}\n\n"                              â”‚
â”‚ "ğŸ“… {date} â€¢ {source_emoji} {duration}"                     â”‚
â”‚ "ğŸ’¬ Ask me anything!"                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flow 6: List Conversations (Telegram)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER gá»­i /list                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CommandHandler.handle_list(event)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ConversationRepository.get_user_conversations(user_id)      â”‚
â”‚                                                             â”‚
â”‚ SELECT c.*,                                                 â”‚
â”‚        c.metadata->>'summary' as summary,                  â”‚
â”‚        c.metadata->>'duration_seconds' as duration_seconds,â”‚
â”‚        COUNT(m.id) as message_count                          â”‚
â”‚ FROM conversations c                                        â”‚
â”‚ LEFT JOIN messages m ON c.id = m.conversation_id            â”‚
â”‚ WHERE c.user_id = ?                                         â”‚
â”‚ GROUP BY c.id                                                â”‚
â”‚ ORDER BY c.created_at DESC                                  â”‚
â”‚                                                             â”‚
â”‚ Return: List[{                                               â”‚
â”‚   id, title, platform, source_type,                        â”‚
â”‚   is_active, created_at,                                    â”‚
â”‚   summary, duration_seconds (from metadata),                â”‚
â”‚   message_count                                             â”‚
â”‚ }]                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [RESPONSE]                                                   â”‚
â”‚                                                             â”‚
â”‚ Format vÃ  hiá»ƒn thá»‹ danh sÃ¡ch conversations                 â”‚
â”‚ vá»›i emoji active indicator                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Key Design Points

### 1. **Conversations Table Fields**

```
conversations:
â”œâ”€ id (UUID, PK)              â† Telegram/Mobile tá»± táº¡o
â”œâ”€ user_id (TEXT)             â† User identifier (link to user_profiles.user_id)
â”œâ”€ transcription_id (FK)     â† Link to transcriptions
â”œâ”€ title (VARCHAR)           â† Title cá»§a conversation (copy tá»« metadata)
â”œâ”€ platform (VARCHAR)        â† 'telegram' or 'mobile'
â”œâ”€ metadata (JSON)            â† Extra data: {summary, duration, file_path, ...}
â”œâ”€ source_type (VARCHAR)      â† 'audio', 'video', 'voice_message', 'url'
â”œâ”€ is_active (BOOLEAN)       â† Active conversation flag
â”œâ”€ created_at (TIMESTAMP)     â† Creation time
â””â”€ updated_at (TIMESTAMP)     â† Last update time (auto-updated)
```

### 2. **Metadata Field Structure**

```json
{
  "summary": "Brief summary of the transcription",
  "duration_seconds": 120,
  "transcript_file_path": "s3://bucket/transcript.txt",
  "additional_info": "..."
}
```

### 3. **UUID Generation Strategy**

```
Telegram Handler:
â”œâ”€> conversation_id = uuid4()  â† Telegram handler tá»± táº¡o
â””â”€> LÆ°u vÃ o database khi táº¡o conversation
â”‚   (Telegram handler cÃ³ quyá»n táº¡o conversation_id)
â”‚
Mobile Handler:
â”œâ”€> conversation_id = uuid4()  â† Mobile handler tá»± táº¡o
â””â”€> Gá»­i conversation_id lÃªn API khi transcribe
â”‚   API sáº½ dÃ¹ng conversation_id nÃ y Ä‘á»ƒ táº¡o conversation
â”‚   (Mobile handler cÃ³ quyá»n táº¡o conversation_id)
â”‚
Transcription:
â””â”€> transcription_id = UUID (auto-generated by API/DB)
    (API tá»± táº¡o khi transcribe)
```

**PhÃ¢n chia trÃ¡ch nhiá»‡m:**
- **Telegram**: Telegram handler tá»± táº¡o vÃ  quáº£n lÃ½ conversation_id
- **Mobile**: Mobile handler tá»± táº¡o conversation_id, gá»­i lÃªn API
- **API**: Chá»‰ táº¡o transcription_id, nháº­n conversation_id tá»« Mobile

### 4. **Active Conversation Management**

```
Khi táº¡o conversation má»›i:
â”œâ”€> Deactivate táº¥t cáº£ conversations cÅ© cá»§a user
â”‚   UPDATE conversations 
â”‚   SET is_active = FALSE, updated_at = CURRENT_TIMESTAMP
â”‚   WHERE user_id = ? AND is_active = TRUE
â”‚
â””â”€> Activate conversation má»›i
    INSERT INTO conversations (
      id, user_id, transcription_id,
      title, platform, metadata, source_type,
      is_active, created_at, updated_at
    ) VALUES (?, ?, ?, ?, ?, ?, ?, TRUE, NOW(), NOW())

Khi switch conversation:
â”œâ”€> Deactivate conversation hiá»‡n táº¡i
â””â”€> Activate conversation má»›i
    (Cáº£ 2 Ä‘á»u update updated_at)
```

### 5. **User Profiles**

```
user_profiles:
â”œâ”€ id (UUID, PK)              â† Primary key
â”œâ”€ user_id (TEXT)             â† User identifier (unique, cÃ³ thá»ƒ lÃ  Telegram user_id hoáº·c Mobile user_id)
â”œâ”€ first_name (TEXT)          â† TÃªn cá»§a user
â”œâ”€ last_name (TEXT)           â† Há» cá»§a user
â”œâ”€ avatar_url (TEXT)          â† URL cá»§a avatar image (optional)
â”œâ”€ created_at (TIMESTAMP)     â† Creation time
â””â”€ updated_at (TIMESTAMP)     â† Last update time (auto-updated)
```

### 6. **Data Flow Summary**

```
User Profile (1) â”€â”€â”
                    â”‚
                    â”œâ”€â”€> Transcription (N) â”€â”€â”
                    â”‚                         â”‚
                    â”‚                         â”œâ”€â”€> Conversation (N) â”€â”€> Messages (N)
                    â”‚                         â”‚
                    â””â”€â”€> Má»—i conversation chá»‰ cÃ³ 1 transcription
                         (Foreign Key: conversations.transcription_id)
                         
User Profile lÆ°u:
- user_id (TEXT) - unique identifier
- first_name, last_name - ThÃ´ng tin cÃ¡ nhÃ¢n
- avatar_url - Avatar image URL

Transcription chá»‰ lÆ°u:
- transcription_id (UUID, PK)
- content (TEXT) - Full transcription text
- created_at

Conversation lÆ°u:
- title (title cá»§a conversation)
- platform (telegram/mobile)
- metadata (JSON vá»›i summary, duration_seconds, file_path, ...)
- source_type (audio, video, voice_message, etc.)
- is_active, created_at, updated_at
```

---

## Database Queries Summary

### User Profiles

#### Create/Update User Profile
```sql
-- Create new user profile
INSERT INTO user_profiles (id, user_id, first_name, last_name, avatar_url, created_at, updated_at)
VALUES (uuid_generate_v4(), ?, ?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
ON CONFLICT (user_id) 
DO UPDATE SET 
    first_name = EXCLUDED.first_name,
    last_name = EXCLUDED.last_name,
    avatar_url = EXCLUDED.avatar_url,
    updated_at = CURRENT_TIMESTAMP
RETURNING id;
```

#### Get User Profile
```sql
SELECT * FROM user_profiles
WHERE user_id = ?;
```

#### Update User Profile
```sql
UPDATE user_profiles
SET 
    first_name = ?,
    last_name = ?,
    avatar_url = ?,
    updated_at = CURRENT_TIMESTAMP
WHERE user_id = ?
RETURNING *;
```

### Create Transcription
```sql
INSERT INTO transcriptions 
(transcription_id, content)
VALUES (uuid_generate_v4(), ?)
RETURNING transcription_id;
```

### Create Conversation
```sql
-- Deactivate old conversations
UPDATE conversations 
SET is_active = FALSE, updated_at = CURRENT_TIMESTAMP
WHERE user_id = ? AND is_active = TRUE;

-- Create new conversation
INSERT INTO conversations 
(id, user_id, transcription_id, title, platform, metadata, source_type, is_active, created_at, updated_at)
VALUES (?, ?, ?, ?, ?, ?::jsonb, ?, TRUE, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
RETURNING id;
```

### Get Active Conversation
```sql
SELECT 
    c.id,
    c.user_id,
    c.transcription_id,
    c.title,
    c.platform,
    c.metadata,
    c.source_type,
    c.is_active,
    c.created_at,
    c.updated_at,
    t.content as transcription_content
FROM conversations c
JOIN transcriptions t ON c.transcription_id = t.transcription_id
WHERE c.user_id = ? AND c.is_active = TRUE
ORDER BY c.updated_at DESC
LIMIT 1;
```

### Get Conversation by ID
```sql
SELECT 
    c.*,
    t.content as transcription_content
FROM conversations c
JOIN transcriptions t ON c.transcription_id = t.transcription_id
WHERE c.id = ?;
```

### Get User Conversations (for /list)
```sql
SELECT 
    c.id,
    c.title,
    c.platform,
    c.source_type,
    c.is_active,
    c.created_at,
    c.updated_at,
    c.metadata->>'summary' as summary,
    c.metadata->>'duration_seconds' as duration_seconds,
    COUNT(m.id) as message_count
FROM conversations c
LEFT JOIN messages m ON c.id = m.conversation_id
WHERE c.user_id = ?
GROUP BY c.id
ORDER BY c.created_at DESC;
```

### Get Conversation History
```sql
SELECT 
    role, 
    content, 
    file_url,
    file_name,
    file_type,
    file_size,
    created_at
FROM messages
WHERE conversation_id = ?
ORDER BY created_at ASC;
```

### Add Message
```sql
-- Message vá»›i text only
INSERT INTO messages (conversation_id, role, content, file_url, file_name, file_type, file_size)
VALUES (?, ?, ?, NULL, NULL, NULL, NULL);

-- Message vá»›i file Ä‘Ã­nh kÃ¨m
INSERT INTO messages (conversation_id, role, content, file_url, file_name, file_type, file_size)
VALUES (?, ?, ?, ?, ?, ?, ?);
```

**Fields:**
- `conversation_id`: UUID cá»§a conversation
- `role`: 'user' hoáº·c 'assistant'
- `content`: Text content cá»§a message
- `file_url`: URL cá»§a file (S3 URL hoáº·c local path) - optional
- `file_name`: TÃªn file gá»‘c - optional
- `file_type`: Loáº¡i file ('image', 'video', 'audio', 'document') - optional
- `file_size`: KÃ­ch thÆ°á»›c file tÃ­nh báº±ng bytes - optional

### Update Conversation (after chat)
```sql
UPDATE conversations
SET updated_at = CURRENT_TIMESTAMP
WHERE id = ?;
```

### Switch Active Conversation
```sql
BEGIN;

-- Deactivate all
UPDATE conversations 
SET is_active = FALSE, updated_at = CURRENT_TIMESTAMP
WHERE user_id = ? AND is_active = TRUE;

-- Activate target
UPDATE conversations 
SET is_active = TRUE, updated_at = CURRENT_TIMESTAMP
WHERE id = ? AND user_id = ?;

COMMIT;
```

---

## Sequence Diagram: Complete Flow

```
Telegram User          Mobile App           API/Handler         Database
    â”‚                     â”‚                     â”‚                  â”‚
    â”‚â”€â”€ Audio/Video â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚
    â”‚                     â”‚                     â”‚                  â”‚
    â”‚                     â”‚                     â”‚â”€â”€ Transcribe â”€â”€â”€â”€>â”‚
    â”‚                     â”‚                     â”‚<â”€ transcript_id â”€â”€â”‚
    â”‚                     â”‚                     â”‚                  â”‚
    â”‚                     â”‚                     â”‚â”€â”€ Create Conv â”€â”€â”€â”€>â”‚
    â”‚                     â”‚                     â”‚  (title, platform,â”‚
    â”‚                     â”‚                     â”‚   metadata, source)â”‚
    â”‚                     â”‚                     â”‚<â”€ conversation_id â”€â”‚
    â”‚<â”€ Confirmation â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚
    â”‚                     â”‚                     â”‚                  â”‚
    â”‚â”€â”€ Text Message â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚
    â”‚                     â”‚                     â”‚                  â”‚
    â”‚                     â”‚                     â”‚â”€â”€ Get Active â”€â”€â”€â”€>â”‚
    â”‚                     â”‚                     â”‚<â”€ conversation â”€â”€â”€â”‚
    â”‚                     â”‚                     â”‚  (with title,     â”‚
    â”‚                     â”‚                     â”‚   metadata, etc.)  â”‚
    â”‚                     â”‚                     â”‚  (includes        â”‚
    â”‚                     â”‚                     â”‚   transcription_   â”‚
    â”‚                     â”‚                     â”‚   content via JOIN)â”‚
    â”‚                     â”‚                     â”‚                  â”‚
    â”‚                     â”‚                     â”‚â”€â”€ Get History â”€â”€â”€â”€>â”‚
    â”‚                     â”‚                     â”‚<â”€ messages â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                     â”‚                     â”‚                  â”‚
    â”‚                     â”‚                     â”‚â”€â”€ AI Response â”€â”€â”€â”€>â”‚
    â”‚                     â”‚                     â”‚<â”€ ai_response â”€â”€â”€â”€â”‚
    â”‚                     â”‚                     â”‚                  â”‚
    â”‚                     â”‚                     â”‚â”€â”€ Save Messages â”€>â”‚
    â”‚                     â”‚                     â”‚â”€â”€ Update Conv â”€â”€â”€â”€>â”‚
    â”‚                     â”‚                     â”‚                  â”‚
    â”‚<â”€ AI Response â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚
    â”‚                     â”‚                     â”‚                  â”‚
```

